name: üì° Sync Status to Hub

on:
  issues:
    types: [closed, reopened, labeled, unlabeled]
  issue_comment:
    types: [created, edited]

jobs:
  sync-to-hub:
    runs-on: ubuntu-latest
    steps:
      - name: Check if from Hub and sync status
        uses: actions/github-script@v7
        env:
          HUB_PAT: ${{ secrets.ADD_TO_PROJECT_PAT }}
        with:
          script: |
            const { issue, label, comment } = context.payload;

            // –î–ª—è —Å–æ–±—ã—Ç–∏–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –ø—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –≤ issue –∏–∑ Hub
            if (context.eventName === 'issue_comment') {
              const issueForComment = context.payload.issue;
              const isFromHub = issueForComment.labels.some(label => label.name === 'state/from-hub');
              if (!isFromHub) {
                console.log('‚ÑπÔ∏è Not a Hub issue comment, skipping sync');
                return;
              }
              
              // –ò—â–µ–º –Ω–æ–º–µ—Ä Hub issue –≤ –æ–ø–∏—Å–∞–Ω–∏–∏
              const hubIssueMatch = issueForComment.body.match(/Hub Issue.*#(\d+)/);
              if (!hubIssueMatch) {
                console.log('‚ùå Hub issue reference not found in comment issue');
                return;
              }
              
              const hubIssueNumber = parseInt(hubIssueMatch[1]);
              const [hubOwner, hubRepoName] = '${{ github.repository_owner }}/cdek-ui'.split('/');
              
              await syncCommentToHub(comment, issueForComment, hubIssueNumber, hubOwner, hubRepoName);
              return;
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –∑–∞–¥–∞—á–∞ —Å–æ–∑–¥–∞–Ω–∞ –∏–∑ Hub
            const isFromHub = issue.labels.some(label => label.name === 'state/from-hub');
            if (!isFromHub) {
              console.log('‚ÑπÔ∏è Not a Hub issue, skipping sync');
              return;
            }
            
            // –ò—â–µ–º –Ω–æ–º–µ—Ä Hub issue –≤ –æ–ø–∏—Å–∞–Ω–∏–∏
            const hubIssueMatch = issue.body.match(/Hub Issue.*#(\d+)/);
            if (!hubIssueMatch) {
              console.log('‚ùå Hub issue reference not found');
              return;
            }
            
            const hubIssueNumber = parseInt(hubIssueMatch[1]);
            const hubRepo = '${{ github.repository_owner }}/cdek-ui';
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø —Å–æ–±—ã—Ç–∏—è –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –ª–µ–π–±–ª–æ–≤
            if (context.eventName === 'issues' && (context.payload.action === 'labeled' || context.payload.action === 'unlabeled')) {
              await syncLabelsToHub(issue, hubIssueNumber, hubRepo, label);
            }
            
            await syncStatusToHub(issue, hubIssueNumber, hubRepo);
            
            async function syncStatusToHub(satelliteIssue, hubIssueNumber, hubRepo) {
              let status = '';
              let statusMessage = '';
              let shouldReopen = false;
              
              // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏ –ª–µ–π–±–ª–æ–≤
              if (satelliteIssue.state === 'closed') {
                status = 'closed';
                statusMessage = '‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–æ –≤ Satellite';
              } else if (satelliteIssue.state === 'open') {
                // –ï—Å–ª–∏ issue –±—ã–ª–∞ –ø–µ—Ä–µ–æ—Ç–∫—Ä—ã—Ç–∞ (reopened)
                if (context.payload.action === 'reopened') {
                  status = 'open';
                  statusMessage = 'üîÑ –ü–µ—Ä–µ–æ—Ç–∫—Ä—ã—Ç–æ –≤ Satellite';
                  shouldReopen = true;
                  }
               } else if (satelliteIssue.state === 'open') {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –ª–µ–π–±–ª–∞ status/in-progress
                const hasInProgressLabel = satelliteIssue.labels.some(label => label.name === 'status/in-progress');
                if (hasInProgressLabel) {
                  status = 'status/in-progress';
                  statusMessage = 'üîß –í —Ä–∞–±–æ—Ç–µ';
                } else {
                  status = 'open';
                  statusMessage = 'üìã –û—Ç–∫—Ä—ã—Ç–æ –≤ Satellite';
                }
              }
              
              if (!status) return;
              
              // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –≤ Hub
              await updateHubStatus(hubIssueNumber, status, statusMessage, satelliteIssue, hubRepo, shouldReopen);
            }
            
            async function syncLabelsToHub(satelliteIssue, hubIssueNumber, hubRepo, changedLabel) {
              try {
                const syncPrefixes = ['status/', 'priority/', 'area/', 'type/'];
                const changedLabelName = changedLabel?.name;
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –ª–∏ –∏–∑–º–µ–Ω–µ–Ω–Ω—ã–π –ª–µ–π–±–ª –∫ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º—ã–º
                const shouldSync = syncPrefixes.some(prefix => changedLabelName?.startsWith(prefix));
                if (!shouldSync) {
                  console.log('‚ÑπÔ∏è Label not in sync scope: ' + changedLabelName);
                  return;
                }
                
                console.log('üîÑ Syncing label: ' + changedLabelName);
                
                // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–µ –ª–µ–π–±–ª—ã satellite issue
                const currentLabels = satelliteIssue.labels.map(l => l.name);
                
                // –§–∏–ª—å—Ç—Ä—É–µ–º –ª–µ–π–±–ª—ã –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ - –±–µ—Ä–µ–º –í–°–ï –ª–µ–π–±–ª—ã —Å –Ω—É–∂–Ω—ã–º–∏ –ø—Ä–µ—Ñ–∏–∫—Å–∞–º–∏
                const labelsToSync = currentLabels.filter(labelName => 
                  syncPrefixes.some(prefix => labelName.startsWith(prefix))
                );
                
                console.log('üìã All labels to sync from satellite: ' + labelsToSync.join(', '));
                
                // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–µ –ª–µ–π–±–ª—ã hub issue –∏—Å–ø–æ–ª—å–∑—É—è PAT
                const hubIssueResponse = await fetch(
                  `https://api.github.com/repos/${hubRepo}/issues/${hubIssueNumber}`,
                  {
                    headers: {
                      'Authorization': `token ${process.env.HUB_PAT}`,
                      'Accept': 'application/vnd.github.v3+json'
                    }
                  }
                );
                
                if (!hubIssueResponse.ok) {
                  throw new Error(`Failed to get hub issue: ${hubIssueResponse.status}`);
                }
                
                const hubIssue = await hubIssueResponse.json();
                const currentHubLabels = hubIssue.labels.map(l => l.name);
                
                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–∞–∫–∏–µ –ª–µ–π–±–ª—ã –Ω—É–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å –∏–∑ hub
                const labelsToRemove = [];
                
                // –î–ª—è –∫–∞–∂–¥–æ–≥–æ –ø—Ä–µ—Ñ–∏–∫—Å–∞ –Ω–∞—Ö–æ–¥–∏–º —Ç–µ–∫—É—â–∏–π –ª–µ–π–±–ª –≤ hub –∏ —Å—Ä–∞–≤–Ω–∏–≤–∞–µ–º —Å satellite
                for (const prefix of syncPrefixes) {
                  const satelliteLabelForPrefix = labelsToSync.find(label => label.startsWith(prefix));
                  const hubLabelForPrefix = currentHubLabels.find(label => label.startsWith(prefix));
                  
                  // –ï—Å–ª–∏ –≤ hub –µ—Å—Ç—å –ª–µ–π–±–ª —ç—Ç–æ–≥–æ –ø—Ä–µ—Ñ–∏–∫—Å–∞, –Ω–æ –≤ satellite –µ–≥–æ –Ω–µ—Ç –∏–ª–∏ –æ–Ω –¥—Ä—É–≥–æ–π - —É–¥–∞–ª—è–µ–º
                  if (hubLabelForPrefix && hubLabelForPrefix !== satelliteLabelForPrefix) {
                    labelsToRemove.push(hubLabelForPrefix);
                  }
                  
                  // –ï—Å–ª–∏ –≤ satellite –µ—Å—Ç—å –ª–µ–π–±–ª, –Ω–æ –≤ hub –µ–≥–æ –Ω–µ—Ç - –æ–Ω –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω –Ω–∏–∂–µ
                }
                
                // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –ª–µ–π–±–ª—ã –∏–∑ hub
                for (const labelToRemove of labelsToRemove) {
                  await fetch(
                    `https://api.github.com/repos/${hubRepo}/issues/${hubIssueNumber}/labels/${encodeURIComponent(labelToRemove)}`,
                    {
                      method: 'DELETE',
                      headers: {
                        'Authorization': `token ${process.env.HUB_PAT}`,
                        'Accept': 'application/vnd.github.v3+json'
                      }
                    }
                  );
                  console.log('üóëÔ∏è Removed label from Hub: ' + labelToRemove);
                }
                
                // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ –ª–µ–π–±–ª—ã (—Ç–æ–ª—å–∫–æ —Ç–µ, –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ—Ç –≤ hub)
                const labelsToAdd = labelsToSync.filter(labelName => 
                  !currentHubLabels.includes(labelName)
                );
                
                if (labelsToAdd.length > 0) {
                  await fetch(
                    `https://api.github.com/repos/${hubRepo}/issues/${hubIssueNumber}/labels`,
                    {
                      method: 'POST',
                      headers: {
                        'Authorization': `token ${process.env.HUB_PAT}`,
                        'Content-Type': 'application/json',
                        'Accept': 'application/vnd.github.v3+json'
                      },
                      body: JSON.stringify(labelsToAdd)
                    }
                  );
                  console.log('‚úÖ Added labels to Hub: ' + labelsToAdd.join(', '));
                }
                
                // –°–æ–∑–¥–∞–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –ª–µ–π–±–ª–æ–≤
                if (labelsToRemove.length > 0 || labelsToAdd.length > 0) {
                  const commentLines = [];
                  
                  if (labelsToAdd.length > 0) {
                    commentLines.push('**–î–æ–±–∞–≤–ª–µ–Ω—ã**: `' + labelsToAdd.join('`, `') + '`');
                  }
                  
                  if (labelsToRemove.length > 0) {
                    commentLines.push('**–£–¥–∞–ª–µ–Ω—ã**: `' + labelsToRemove.join('`, `') + '`');
                  }
                  
                  // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–µ–∫—É—â–∏—Ö —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ª–µ–π–±–ª–∞—Ö
                  const currentSyncInfo = [];
                  for (const prefix of syncPrefixes) {
                    const labelForPrefix = labelsToSync.find(label => label.startsWith(prefix));
                    if (labelForPrefix) {
                      currentSyncInfo.push(`**${prefix}**: \`${labelForPrefix}\``);
                    }
                  }
                  
                  if (currentSyncInfo.length > 0) {
                    commentLines.push('**–¢–µ–∫—É—â–∏–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ª–µ–π–±–ª—ã**:\n' + currentSyncInfo.join('\n'));
                  }
                }
                
                console.log(`‚úÖ Synced labels to Hub #${hubIssueNumber}`);
                
              } catch (error) {
                console.log(`‚ùå Failed to sync labels to Hub: ${error.message}`);
              }
            }

            async function syncCommentToHub(satelliteComment, satelliteIssue, hubIssueNumber, hubOwner, hubRepo) {
              try {
                console.log('üí¨ Syncing comment to Hub');
                
                // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –æ—Ç –±–æ—Ç–æ–≤ –∏ —Å–∏—Å—Ç–µ–º–Ω—ã–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
                if (satelliteComment.user.type === 'Bot' || 
                    satelliteComment.body.includes('üîÑ –°—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–ª–µ–Ω') ||
                    satelliteComment.body.includes('üè∑Ô∏è –õ–µ–π–±–ª—ã —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã') ||
                    satelliteComment.body.includes('‚úÖ –ó–∞–¥–∞—á–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–Ω–∞') ||
                    satelliteComment.body.includes('üí¨ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∏–∑ Hub') ||
                    satelliteComment.body.includes('üîÑ –°—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–ª–µ–Ω –∏–∑ Hub')) {
                  console.log('‚ÑπÔ∏è Skipping bot or system comment');
                  return;
                }
                
                const commentBody = '**üí¨ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∏–∑ Satellite**\n\n' +
                                    '**Satellite**: `' + context.repo.repo + '`\n' +
                                    '**Issue**: [#' + satelliteIssue.number + '](' + satelliteIssue.html_url + ')\n' +
                                    '**–ê–≤—Ç–æ—Ä**: @' + satelliteComment.user.login + '\n' +
                                    '**–í—Ä–µ–º—è**: ' + new Date(satelliteComment.created_at).toLocaleString() + '\n\n' +
                                    '---\n\n' +
                                    satelliteComment.body + '\n\n' +
                                    '---\n\n' +
                                    '*–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏*';
                
                const response = await fetch(
                  `https://api.github.com/repos/${hubOwner}/${hubRepo}/issues/${hubIssueNumber}/comments`,
                  {
                    method: 'POST',
                    headers: {
                      'Authorization': `token ${process.env.HUB_PAT}`,
                      'Content-Type': 'application/json',
                      'Accept': 'application/vnd.github.v3+json'
                    },
                    body: JSON.stringify({
                      body: commentBody
                    })
                  }
                );
                
                if (!response.ok) {
                  throw new Error(`Failed to create comment in hub: ${response.status}`);
                }
                
                console.log(`‚úÖ Synced comment to Hub #${hubIssueNumber}`);
                
              } catch (error) {
                console.log(`‚ùå Failed to sync comment to Hub: ${error.message}`);
              }
            }
            
            async function updateHubStatus(hubIssueNumber, status, statusMessage, satelliteIssue, hubRepo, shouldReopen = false) {
              try {
                // –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –≤ Hub –∏—Å–ø–æ–ª—å–∑—É—è PAT
                await fetch(
                  `https://api.github.com/repos/${hubRepo}/issues/${hubIssueNumber}/comments`,
                  {
                    method: 'POST',
                    headers: {
                      'Authorization': `token ${process.env.HUB_PAT}`,
                      'Content-Type': 'application/json',
                      'Accept': 'application/vnd.github.v3+json'
                    },
                    body: JSON.stringify({
                      body: '**üîÑ –°—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–ª–µ–Ω –∏–∑ Satellite**\n\n' +
                            '**Satellite**: `' + context.repo.repo + '`\n' +
                            '**Issue**: [#' + satelliteIssue.number + '](' + satelliteIssue.html_url + ')\n' +
                            '**–°—Ç–∞—Ç—É—Å**: ' + statusMessage + '\n' +
                            '**–í—Ä–µ–º—è**: ' + new Date().toLocaleString()
                    })
                  }
                );
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –º–µ—Ç–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ –≤ Hub
                const statusLabels = {
                  'in-progress': 'status/in-progress'
                };
                
                const newStatusLabel = statusLabels[status];
                if (newStatusLabel) {
                  // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–µ –ª–µ–π–±–ª—ã hub issue
                  const hubIssueResponse = await fetch(
                    `https://api.github.com/repos/${hubRepo}/issues/${hubIssueNumber}`,
                    {
                      headers: {
                        'Authorization': `token ${process.env.HUB_PAT}`,
                        'Accept': 'application/vnd.github.v3+json'
                      }
                    }
                  );
                  
                  if (!hubIssueResponse.ok) {
                    throw new Error(`Failed to get hub issue: ${hubIssueResponse.status}`);
                  }
                  
                  const hubIssue = await hubIssueResponse.json();
                  
                  // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ —Å—Ç–∞—Ç—É—Å–Ω—ã–µ –º–µ—Ç–∫–∏
                  const oldStatusLabels = hubIssue.labels
                    .filter(label => label.name.startsWith('status/') && label.name !== newStatusLabel)
                    .map(label => label.name);
                  
                  for (const oldLabel of oldStatusLabels) {
                    await fetch(
                      `https://api.github.com/repos/${hubRepo}/issues/${hubIssueNumber}/labels/${encodeURIComponent(oldLabel)}`,
                      {
                        method: 'DELETE',
                        headers: {
                          'Authorization': `token ${process.env.HUB_PAT}`,
                          'Accept': 'application/vnd.github.v3+json'
                        }
                      }
                    );
                  }
                  
                  // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—É—é —Å—Ç–∞—Ç—É—Å–Ω—É—é –º–µ—Ç–∫—É
                  await fetch(
                    `https://api.github.com/repos/${hubRepo}/issues/${hubIssueNumber}/labels`,
                    {
                      method: 'POST',
                      headers: {
                        'Authorization': `token ${process.env.HUB_PAT}`,
                        'Content-Type': 'application/json',
                        'Accept': 'application/vnd.github.v3+json'
                      },
                      body: JSON.stringify([newStatusLabel])
                    }
                  );
                }
                
                // –ï—Å–ª–∏ –∑–∞–¥–∞—á–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ –≤ Satellite, –∑–∞–∫—Ä—ã–≤–∞–µ–º –≤ Hub
                if (status === 'closed') {
                  await fetch(
                    `https://api.github.com/repos/${hubRepo}/issues/${hubIssueNumber}`,
                    {
                      method: 'PATCH',
                      headers: {
                        'Authorization': `token ${process.env.HUB_PAT}`,
                        'Content-Type': 'application/json',
                        'Accept': 'application/vnd.github.v3+json'
                      },
                      body: JSON.stringify({
                        state: 'closed'
                      })
                    }
                  );
                }
                if (shouldReopen) {
                  await fetch(
                    `https://api.github.com/repos/${hubRepo}/issues/${hubIssueNumber}`,
                    {
                      method: 'PATCH',
                      headers: {
                        'Authorization': `token ${process.env.HUB_PAT}`,
                        'Content-Type': 'application/json',
                        'Accept': 'application/vnd.github.v3+json'
                      },
                      body: JSON.stringify({
                        state: 'open'
                      })
                    }
                  );
                  console.log('üîì Reopened issue in Hub');
                }
                
                
                console.log(`‚úÖ Synced status to Hub #${hubIssueNumber}: ${status}`);
                
              } catch (error) {
                console.log(`‚ùå Failed to sync status to Hub: ${error.message}`);
              }
            }
